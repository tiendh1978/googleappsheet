<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HÓA ĐƠN BÁN HÀNG - CÔNG TY TRUNG KHẢI</title>
    <style>
        /* Reset CSS */
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.4;
        }
        
        /* Layout chung */
        body {
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .invoice-container {
            width: 200mm;
            min-height: 138mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 10mm 15mm;
            margin: 0 auto;
            position: relative;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 2px solid #333;
            padding-bottom: 6px;
        }
        
        .bank-info {
            width: 25%;
            font-size: 12px;
            padding-left: 2mm;
        }
        
        .bank-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .company-info {
            width: 50%;
            text-align: center;
        }
        
        .company-name {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            color: #0066cc;
        }
        
        .qr-section {
            width: 25%;
            display: flex;
            justify-content: flex-end;
            padding-right: 2mm;
        }
        
        .qr-code {
            width: 85px; /* Tăng 20% từ 70px */
            height: 85px;
            object-fit: contain;
        }
        
        /* Tiêu đề hóa đơn */
        .invoice-title {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 8px 0;
            text-align: center;
        }
        
        /* Thông tin đơn hàng */
        .order-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .address-row {
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .address-notes {
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
        }
        
        /* Bảng sản phẩm */
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 12px;
            table-layout: fixed;
        }
        
        .product-table th {
            background-color: #0066cc;
            color: white;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        
        .product-table td {
            border: 1px solid #ddd;
            padding: 3px;
            text-align: center;
            word-wrap: break-word;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        
        /* Ghi chú */
        .notes {
            margin-top: 8px;
            font-size: 12px;
            page-break-inside: avoid;
        }
        
        /* Thiết lập khi in */
        @media print {
            @page {
                size: A5 landscape;
                margin: 5mm;
            }
            body {
                margin: 0;
                padding: 0;
                background: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                width: 200mm;
            }
            .invoice-container {
                width: 200mm;
                min-height: 138mm;
                margin: 0;
                padding: 8mm 12mm;
                box-shadow: none;
            }
            /* Đảm bảo không bị cắt nội dung */
            .notes, .product-table {
                page-break-inside: avoid;
            }
            .qr-code {
                width: 85px;
                height: 85px;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="header">
            <div class="bank-info">
                <div class="bank-title">TÀI KHOẢN NGÂN HÀNG</div>
                <div>Tên TK: BÙI THUÝ VÂN</div>
                <div>Số TK: 19036542358012</div>
                <div>Ngân hàng: TECHCOMBANK</div>
            </div>
            <div class="company-info">
                <div class="company-name">CÔNG TY TNHH TRUNG KHẢI</div>
                <div style="font-weight: bold; margin: 2px 0; font-size: 14px;">TỔNG ĐẠI LÝ PHÂN PHỐI NƯỚC</div>
                <div style="font-size: 13px;">ĐT: 0334 35 3993 - 0971 60 1771</div>
            </div>
            <div class="qr-section">
                <img id="qr-code-img" src="" alt="QR Code" class="qr-code">
            </div>
        </div>
        
        <div class="invoice-title">HÓA ĐƠN BÁN HÀNG</div>
        
        <div class="order-info">
            <div><strong>Mã đơn hàng:</strong> <span id="order-code">DH001</span></div>
            <div><strong>Ngày:</strong> <span id="order-date">10/07/2024</span></div>
            <div><strong>Điện thoại:</strong> <span id="customer-phone">0912345678</span></div>
        </div>
        
        <div class="address-row">
            <div><strong>Địa chỉ:</strong> <span id="customer-address">123 Đường ABC, Quận 1, TP.HCM</span></div>
        </div>
        
        <div class="address-notes">
            <div><strong>Lưu ý địa chỉ:</strong> <span id="address-notes">Chung cư XYZ, tầng 5, thang máy</span></div>
        </div>
        
        <table class="product-table">
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="15%">Mã SP</th>
                    <th width="30%">Tên sản phẩm</th>
                    <th width="10%">SL</th>
                    <th width="10%">ĐVT</th>
                    <th width="15%">Đơn giá</th>
                    <th width="15%">Thành tiền</th>
                </tr>
            </thead>
            <tbody id="product-body">
                <tr>
                    <td>1</td>
                    <td>SP001</td>
                    <td style="text-align: left;">Nước Lavie 500ml</td>
                    <td>10</td>
                    <td>chai</td>
                    <td>15.000 đ</td>
                    <td>150.000 đ</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>SP002</td>
                    <td style="text-align: left;">Nước Miru 350ml</td>
                    <td>5</td>
                    <td>lon</td>
                    <td>10.000 đ</td>
                    <td>50.000 đ</td>
                </tr>
                <!-- Thêm dòng trống nếu cần -->
                <tr><td>3</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td>4</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td>5</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td>6</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td>7</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6" style="text-align: right;">TỔNG CỘNG:</td>
                    <td style="text-align: center;">200.000 đ</td>
                </tr>
            </tfoot>
        </table>
        
        <div class="notes">
            <p><strong>Ghi chú:</strong></p>
            <p>- Khách thiếu vỏ vui lòng đặt cọc 50.000 đ/vỏ</p>
            <p>- Khách hàng không lấy nước đi thu vỏ sẽ tính phí</p>
            <p>- Phí bê lên tầng 2 là 5.000 đ/bình, tầng 3 là 10.000 đ/bình, tầng 4 là 15.000 đ/bình</p>
            <p>- Quý khách vui lòng hỗ trợ phí gửi xe (nếu có)</p>
        </div>
    </div>

    <script>
        // Phiên bản template
        const TEMPLATE_VERSION = "2024-07-05-v6";
        console.log("Template version:", TEMPLATE_VERSION);
        
        // Hàm lấy tham số từ URL
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
        }

        // Hàm hiển thị dữ liệu
        function displayData() {
            try {
                const headerParam = getUrlParameter('header');
                if (headerParam) {
                    const header = JSON.parse(headerParam);
                    document.getElementById('order-code').textContent = header.MaDonHang || '';
                    document.getElementById('order-date').textContent = header.Ngay || '';
                    document.getElementById('customer-phone').textContent = header.DienThoai || '';
                    document.getElementById('customer-address').textContent = header.DiaChi || '';
                    document.getElementById('address-notes').textContent = header.ThongTinThemDC || '';
                    
                    // Hiển thị QR code thanh toán từ bảng cha
                    if (header.MaQRThanhToan) {
                        document.getElementById('qr-code-img').src = header.MaQRThanhToan;
                    }
                }

                // Tự động in nếu có tham số ?print=true
                if (getUrlParameter('print') === 'true') {
                    setTimeout(() => {
                        window.print();
                    }, 500);
                }
                
            } catch (error) {
                console.error("Error processing invoice data:", error);
                alert('Có lỗi khi tải hóa đơn. Vui lòng kiểm tra lại dữ liệu.');
            }
        }

        // Chạy khi trang tải xong
        document.addEventListener('DOMContentLoaded', displayData);
    </script>
</body>
</html>
