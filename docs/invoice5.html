<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2024-07-05-v4">
    <title>HÓA ĐƠN BÁN HÀNG - CÔNG TY TRUNG KHẢI</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }
        
        .invoice-container {
            width: 210mm;
            height: 148mm; /* Khổ A5 ngang */
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 10mm;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
        }
        
        .logo-section {
            width: 25%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo {
            max-width: 80px;
            margin-bottom: 5px;
        }
        
        .company-info {
            width: 50%;
            text-align: center;
        }
        
        .company-name {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            color: #0066cc;
        }
        
        .qr-section {
            width: 25%;
            display: flex;
            justify-content: flex-end;
        }
        
        .qr-code {
            max-width: 70px;
            max-height: 70px;
        }
        
        .invoice-title {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 10px 0;
            text-align: center;
        }
        
        .order-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .address-row {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .product-table th {
            background-color: #0066cc;
            color: white;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        
        .product-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        
        .notes {
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.4;
            display: flex;
            justify-content: space-between;
        }
        
        .notes-left {
            width: 70%;
        }
        
        .notes-right {
            width: 25%;
            text-align: right;
        }
        
        .footer {
            margin-top: 15px;
            font-size: 12px;
            text-align: center;
            border-top: 1px solid #ddd;
            padding-top: 5px;
        }
        
        @media print {
            body {
                background: none;
            }
            .invoice-container {
                box-shadow: none;
                padding: 0;
                width: 100%;
                height: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="header">
            <div class="logo-section">
                <img src="https://via.placeholder.com/80x40?text=LAVIE" alt="Lavie" class="logo">
                <img src="https://via.placeholder.com/80x40?text=MIRU" alt="Miru" class="logo">
            </div>
            <div class="company-info">
                <div class="company-name">CÔNG TY TNHH TRUNG KHẢI</div>
                <div style="font-weight: bold; margin: 3px 0; font-size: 14px;">TỔNG ĐẠI LÝ PHÂN PHỐI NƯỚC</div>
                <div style="font-size: 13px;">ĐT: 0334 35 3993 - 0971 60 1771</div>
            </div>
            <div class="qr-section">
                <img id="qr-code-img" src="" alt="QR Code" class="qr-code">
            </div>
        </div>
        
        <div class="invoice-title">HÓA ĐƠN BÁN HÀNG</div>
        
        <div class="order-info">
            <div><strong>Mã đơn hàng:</strong> <span id="order-code"></span></div>
            <div><strong>Ngày:</strong> <span id="order-date"></span></div>
            <div><strong>Điện thoại:</strong> <span id="customer-phone"></span></div>
        </div>
        
        <div class="address-row">
            <div><strong>Địa chỉ:</strong> <span id="customer-address"></span></div>
        </div>
        
        <table class="product-table">
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="15%">Mã SP</th>
                    <th width="30%">Tên sản phẩm</th>
                    <th width="10%">SL</th>
                    <th width="10%">ĐVT</th>
                    <th width="15%">Đơn giá</th>
                    <th width="15%">Thành tiền</th>
                </tr>
            </thead>
            <tbody id="product-body">
                <!-- Sản phẩm sẽ được thêm bằng JavaScript -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6" style="text-align: right;">TỔNG CỘNG:</td>
                    <td id="total-amount" style="text-align: center;"></td>
                </tr>
            </tfoot>
        </table>
        
        <div class="notes">
            <div class="notes-left">
                <p><strong>Ghi chú:</strong></p>
                <p>- Đơn hàng được giao từ 8h-21h các ngày trong tuần</p>
                <p>- Quý khách vui lòng kiểm tra hàng trước khi thanh toán</p>
                <p>- Nhân viên sẽ chụp ảnh xác nhận khi giao hàng thành công</p>
                <p>- Mọi thắc mắc vui lòng liên hệ hotline: 0334 35 3993</p>
            </div>
            <div class="notes-right">
                <p><strong>Người nhận hàng</strong></p>
                <p id="receiver-name" style="margin-top: 20px;"></p>
            </div>
        </div>
        
        <div class="footer">
            <p>Cảm ơn Quý khách đã sử dụng dịch vụ của chúng tôi</p>
            <p>Hẹn gặp lại Quý khách trong các đơn hàng tiếp theo</p>
        </div>
    </div>

    <script>
        // Phiên bản template
        const TEMPLATE_VERSION = "2024-07-05-v4";
        console.log("Đang sử dụng template version:", TEMPLATE_VERSION);
        
        // Hàm lấy tham số từ URL
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
        }

        // Hàm xử lý dữ liệu sản phẩm
        function processProducts(productsStr) {
            if (!productsStr) {
                console.error("Không có dữ liệu sản phẩm");
                return [];
            }
            
            console.log("Dữ liệu sản phẩm nhận được:", productsStr);
            
            try {
                const productGroups = productsStr.split('_a_');
                if (productGroups.length !== 6) {
                    throw new Error("Sai cấu trúc dữ liệu sản phẩm");
                }

                const maSPs = productGroups[0].split('_b_');
                const tenSPs = productGroups[1].split('_b_');
                const slBans = productGroups[2].split('_b_');
                const dvts = productGroups[3].split('_b_');
                const donGias = productGroups[4].split('_b_');
                const thanhTiens = productGroups[5].split('_b_');

                const products = [];
                let totalAmount = 0;

                for (let i = 0; i < maSPs.length; i++) {
                    const product = {
                        stt: i + 1,
                        maSP: safeDecode(maSPs[i]),
                        tenSP: safeDecode(tenSPs[i]),
                        slBan: slBans[i] || '0',
                        dvt: safeDecode(dvts[i]),
                        donGia: parseNumber(donGias[i]),
                        thanhTien: parseNumber(thanhTiens[i])
                    };
                    products.push(product);
                    totalAmount += product.thanhTien;
                }

                console.log("Đã xử lý thành công", products.length, "sản phẩm");
                return { products, totalAmount };

            } catch (error) {
                console.error("Lỗi khi xử lý sản phẩm:", error);
                return [];
            }
        }

        // Hàm hỗ trợ decode an toàn
        function safeDecode(value) {
            try {
                return decodeURIComponent(value || '').trim();
            } catch {
                return (value || '').trim();
            }
        }

        // Hàm parse number an toàn
        function parseNumber(value) {
            const num = parseFloat(value || '0');
            return isNaN(num) ? 0 : num;
        }

        // Hàm hiển thị dữ liệu
        function displayData() {
            try {
                console.log("Bắt đầu xử lý hiển thị hóa đơn...");
                
                // Xử lý header
                const headerParam = getUrlParameter('header');
                if (headerParam) {
                    const header = JSON.parse(headerParam);
                    document.getElementById('order-code').textContent = header.MaDonHang || '';
                    document.getElementById('order-date').textContent = header.Ngay || '';
                    document.getElementById('customer-phone').textContent = header.DienThoai || '';
                    document.getElementById('customer-address').textContent = header.DiaChi || '';
                    document.getElementById('receiver-name').textContent = header.NguoiNhan || '';
                    
                    // Hiển thị QR code nếu có
                    if (header.QRCode) {
                        document.getElementById('qr-code-img').src = header.QRCode;
                    }
                    
                    console.log("Đã xử lý xong thông tin header");
                }

                // Xử lý sản phẩm
                const productsParam = getUrlParameter('products');
                const tbody = document.getElementById('product-body');
                tbody.innerHTML = '';
                
                if (productsParam) {
                    const { products, totalAmount } = processProducts(productsParam);
                    
                    // Giới hạn tối đa 7 dòng sản phẩm
                    const displayProducts = products.slice(0, 7);
                    
                    displayProducts.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.stt}</td>
                            <td>${product.maSP}</td>
                            <td style="text-align: left;">${product.tenSP}</td>
                            <td>${product.slBan}</td>
                            <td>${product.dvt}</td>
                            <td>${formatCurrency(product.donGia)}</td>
                            <td>${formatCurrency(product.thanhTien)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Thêm dòng trống nếu cần
                    for (let i = displayProducts.length; i < 7; i++) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = `
                            <td>${i + 1}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        `;
                        tbody.appendChild(emptyRow);
                    }
                    
                    document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
                    console.log("Đã hiển thị", displayProducts.length, "sản phẩm");
                }

                // Tự động in nếu có tham số ?print=true
                if (getUrlParameter('print') === 'true') {
                    console.log("Tự động in hóa đơn...");
                    window.print();
                }
                
                console.log("Xử lý hóa đơn hoàn tất");
                
            } catch (error) {
                console.error("Error processing invoice data:", error);
                alert('Có lỗi khi tải hóa đơn. Vui lòng kiểm tra lại dữ liệu.');
            }
        }

        // Chạy khi trang tải xong
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Trang đã tải xong, bắt đầu xử lý...");
            displayData();
        });
    </script>
</body>
</html>
