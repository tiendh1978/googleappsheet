<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HÓA ĐƠN BÁN HÀNG - CÔNG TY TRUNG KHẢI</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.3;
        }
        body {
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 2mm;
        }
        .invoice-container {
            width: 195mm;
            min-height: 135mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 2mm;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding-bottom: 3px;
        }
        .bank-info {
            width: 25%;
            font-size: 11px;
            padding-left: 1mm;
        }
        .company-info {
            width: 50%;
            text-align: center;
        }
        .company-name {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            color: #0066cc;
            margin-bottom: 2px;
        }
        .qr-code {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }
        .invoice-title {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 5px 0;
            text-align: center;
        }
        .order-info, .additional-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 11px;
        }
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin: 5px 0;
            font-size: 12.5px;
            table-layout: fixed;
        }
        .product-table th {
            background-color: #0066cc;
            color: white;
            padding: 2px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .product-table td {
            border: 1px solid #ddd;
            padding: 2px;
            text-align: center;
        }
        .total-row-bold {
            font-weight: bold;
            background-color: #f2f2f2;
            text-align: right;
            padding-right: 15px;
            font-size: 15px;
        }
        .notes-section {
            margin-top: 5px;
            font-size: 11px;
        }
        @media print {
            @page {
                size: A5 landscape;
                margin: 2mm;
            }
            body {
                background: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .qr-code {
                width: 100px !important;
                height: 100px !important;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="header">
            <div class="bank-info">
                <div style="font-weight:bold">TÀI KHOẢN NGÂN HÀNG</div>
                <div>Tên TK: BÙI THUÝ VÂN</div>
                <div>Số TK: 19036542358012</div>
                <div>Ngân hàng: TECHCOMBANK</div>
            </div>
            <div class="company-info">
                <div class="company-name">CÔNG TY TNHH TRUNG KHẢI</div>
                <div style="font-weight:bold;font-size:12px">TỔNG ĐẠI LÝ PHÂN PHỐI NƯỚC</div>
                <div style="font-size:11px">ĐT: 0334 35 3993 - 0971 60 1771</div>
            </div>
            <div style="width:25%;display:flex;justify-content:flex-end">
                <img id="qr-code-img" src="" alt="QR Code" class="qr-code">
            </div>
        </div>
        
        <div class="invoice-title">HÓA ĐƠN BÁN HÀNG</div>
        
        <div class="order-info">
            <div><strong>Mã đơn hàng:</strong> <span id="order-code"></span></div>
            <div><strong>Ngày:</strong> <span id="order-date"></span></div>
            <div><strong>Điện thoại:</strong> <span id="customer-phone"></span></div>
        </div>
        
        <div class="additional-info">
            <div><strong>Ngày Lấy Gần Nhất:</strong> <span id="last-pickup-date"></span></div>
            <div><strong>Số ngày:</strong> <span id="days-count"></span></div>
            <div><strong>Tổng Lần Lấy:</strong> <span id="total-pickups"></span></div>
        </div>
        
        <div style="margin-bottom:2px;font-size:11px">
            <div><strong>Địa chỉ:</strong> <span id="customer-address"></span></div>
        </div>
        
        <table class="product-table">
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="12%">Mã SP</th>
                    <th width="25%">Tên sản phẩm</th>
                    <th width="8%">SL</th>
                    <th width="8%">ĐVT</th>
                    <th width="12%">Đơn giá</th>
                    <th width="12%">Chiết khấu (đơn vị)</th>
                    <th width="12%">Thành tiền</th>
                </tr>
            </thead>
            <tbody id="product-body"></tbody>
            <tfoot>
                <tr class="total-row-bold">
                    <td colspan="8">
                        TỔNG CỘNG: <span id="total-amount">0</span>-<span id="total-discount">0</span> = <span id="final-amount">0</span>
                        <span style="font-size:12px"> (Tổng Thành Tiền - Tổng Chiết Khấu)</span>
                    </td>
                </tr>
            </tfoot>
        </table>
        
        <div class="notes-section">
            <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                <div style="width:50%"><strong>Ghi chú:</strong></div>
                <div style="width:25%;text-align:center"><strong>Người Giao Hàng</strong></div>
                <div style="width:25%;text-align:right"><strong>Người Nhận Hàng</strong></div>
            </div>
            <div>
                <p>- Khách thiếu vỏ vui lòng đặt cọc 50.000 đ/vỏ</p>
                <p>- Khách hàng không lấy nước đi thu vỏ sẽ tính phí</p>
                <p>- Phí bê lên tầng 2 là 5.000 đ/bình, tầng 3 là 10.000 đ/bình,</p>
                <p>tầng 4 là 15.000 đ/bình</p>
                <p>- Quý khách vui lòng hỗ trợ phí gửi xe (nếu có)</p>
            </div>
        </div>
    </div>

    <script>
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
        }

        function displayData() {
            try {
                // Xử lý header
                const headerParam = getUrlParameter('header');
                if (headerParam) {
                    const header = JSON.parse(headerParam);
                    const lowerHeader = {};
                    
                    // Chuẩn hóa tên trường về chữ thường
                    for (const key in header) {
                        lowerHeader[key.toLowerCase()] = header[key];
                    }

                    document.getElementById('order-code').textContent = lowerHeader.madonhang || '';
                    document.getElementById('order-date').textContent = lowerHeader.ngay || '';
                    document.getElementById('customer-phone').textContent = lowerHeader.dienthoai || '';
                    
                    // HIỂN THỊ ĐỊA CHỈ KÈM THÔNG TIN THÊM TRONG NGOẶC ĐƠN
                    const diaChiChinh = lowerHeader.diachi || '';
                    const thongTinThem = lowerHeader.thongtinthemdc || '';
                    document.getElementById('customer-address').textContent = 
                        diaChiChinh + (thongTinThem ? " (" + thongTinThem + ")" : "");
                    
                    // Các trường mới
                    document.getElementById('last-pickup-date').textContent = lowerHeader.lanlaytruoc || '';
                    document.getElementById('days-count').textContent = lowerHeader.songay || '';
                    document.getElementById('total-pickups').textContent = lowerHeader.tonglanlay || '';
                    
                    // QR code
                    if (lowerHeader.maqrthanhtoan) {
                        document.getElementById('qr-code-img').src = lowerHeader.maqrthanhtoan;
                    }
                }

                // Xử lý sản phẩm
                const productsParam = getUrlParameter('products') || '';
                const productGroups = productsParam.split('_a_');
                const tbody = document.getElementById('product-body');
                tbody.innerHTML = '';
                
                if (productGroups.length >= 7) {
                    const maSPs = productGroups[0].split('_b_');
                    const tenSPs = productGroups[1].split('_b_');
                    const slBans = productGroups[2].split('_b_');
                    const dvts = productGroups[3].split('_b_');
                    const donGias = productGroups[4].split('_b_');
                    const chietKhaus = productGroups[5].split('_b_');
                    const thanhTiens = productGroups[6].split('_b_');
                    
                    let totalAmount = 0;
                    let totalDiscount = 0;
                    
                    for (let i = 0; i < maSPs.length; i++) {
                        const soLuong = parseFloat(slBans[i] || 0);
                        const donGia = parseFloat(donGias[i] || 0);
                        const chietKhauDonVi = parseFloat(chietKhaus[i] || 0);
                        const thanhTien = parseFloat(thanhTiens[i] || 0);
                        
                        // TÍNH TOÁN CHIẾT KHẤU = SỐ LƯỢNG * CHIẾT KHẤU ĐƠN VỊ
                        const chietKhauTong = soLuong * chietKhauDonVi;
                        totalDiscount += chietKhauTong;
                        totalAmount += thanhTien;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${decodeURIComponent(maSPs[i] || '')}</td>
                                <td style="text-align:left">${decodeURIComponent(tenSPs[i] || '')}</td>
                                <td>${soLuong}</td>
                                <td>${decodeURIComponent(dvts[i] || '')}</td>
                                <td>${formatCurrency(donGia)}</td>
                                <td>${formatCurrency(chietKhauDonVi)}</td>
                                <td>${formatCurrency(thanhTien)}</td>
                            </tr>`;
                    }
                    
                    // Cập nhật tổng cộng
                    document.getElementById('total-amount').textContent = formatCurrency(totalAmount).replace(' đ', '');
                    document.getElementById('total-discount').textContent = formatCurrency(totalDiscount).replace(' đ', '');
                    document.getElementById('final-amount').textContent = formatCurrency(totalAmount - totalDiscount).replace(' đ', '');
                }

                // Tự động in
                if (getUrlParameter('print') === 'true') {
                    setTimeout(window.print, 500);
                }
            } catch (error) {
                console.error("Lỗi:", error);
                alert("Có lỗi xảy ra khi tải hóa đơn");
            }
        }

        // Chạy khi trang tải xong
        document.addEventListener('DOMContentLoaded', displayData);
    </script>
</body>
</html>
