<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HÓA ĐƠN BÁN HÀNG - CÔNG TY TRUNG KHẢI</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .invoice-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 15mm;
            margin: 0 auto;
        }
        
        /* (Giữ nguyên các phần CSS khác như trước) */
        
    </style>
</head>
<body>
    <div class="invoice-container">
        <!-- (Giữ nguyên phần HTML header và customer-info như trước) -->
        
        <table class="product-table">
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="15%">Mã SP</th>
                    <th width="30%">Tên sản phẩm</th>
                    <th width="10%">SL</th>
                    <th width="10%">ĐVT</th>
                    <th width="15%">Đơn giá</th>
                    <th width="15%">Thành tiền</th>
                </tr>
            </thead>
            <tbody id="product-body">
                <!-- Sản phẩm sẽ được thêm bằng JavaScript -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6" style="text-align: right;">TỔNG CỘNG:</td>
                    <td id="total-amount" style="text-align: center;"></td>
                </tr>
            </tfoot>
        </table>
        
        <!-- (Giữ nguyên phần notes và signature như trước) -->
    </div>

    <script>
        // Hàm lấy tham số từ URL
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
        }

        // Hàm xử lý dữ liệu sản phẩm (phiên bản mới)
        function processProducts(productsStr) {
            if (!productsStr) return [];
            
            // Tách toàn bộ các giá trị bằng "_a_" trước
            const allValues = productsStr.split('_a_');
            
            // Mỗi sản phẩm có 6 thuộc tính nên số sản phẩm = tổng số giá trị / 6
            const productCount = allValues.length / 6;
            const products = [];
            let totalAmount = 0;
            
            // Tách tiếp từng nhóm giá trị bằng "_b_" trong mỗi phần
            const columns = [];
            for (let i = 0; i < 6; i++) {
                columns[i] = allValues[i].split('_b_');
            }
            
            // Tạo danh sách sản phẩm
            for (let i = 0; i < productCount; i++) {
                const product = {
                    stt: i + 1,
                    maSP: safeDecode(columns[0][i]),      // Mã SP
                    tenSP: safeDecode(columns[1][i]),     // Tên SP
                    slBan: columns[2][i] || '0',         // Số lượng
                    dvt: safeDecode(columns[3][i]),      // Đơn vị tính
                    donGia: parseNumber(columns[4][i]),  // Đơn giá
                    thanhTien: parseNumber(columns[5][i]) // Thành tiền
                };
                products.push(product);
                totalAmount += product.thanhTien;
            }
            
            return { products, totalAmount };
        }

        // Hàm hỗ trợ decode an toàn
        function safeDecode(value) {
            try {
                return decodeURIComponent(value || '').trim();
            } catch {
                return (value || '').trim();
            }
        }

        // Hàm parse number an toàn
        function parseNumber(value) {
            const num = parseFloat(value || '0');
            return isNaN(num) ? 0 : num;
        }

        // Hàm hiển thị dữ liệu
        function displayData() {
            try {
                // Xử lý header (giữ nguyên như trước)
                const headerParam = getUrlParameter('header');
                if (headerParam) {
                    const header = JSON.parse(headerParam);
                    document.getElementById('order-code').textContent = header.MaDonHang || '';
                    document.getElementById('order-date').textContent = header.Ngay || '';
                    document.getElementById('customer-name').textContent = header.TenKhachHang || '';
                    document.getElementById('customer-phone').textContent = header.DienThoai || '';
                    document.getElementById('customer-address').textContent = header.DiaChi || '';
                }

                // Xử lý sản phẩm với logic mới
                const productsParam = getUrlParameter('products');
                const tbody = document.getElementById('product-body');
                tbody.innerHTML = '';
                
                if (productsParam) {
                    const { products, totalAmount } = processProducts(productsParam);
                    
                    products.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.stt}</td>
                            <td>${product.maSP}</td>
                            <td style="text-align: left;">${product.tenSP}</td>
                            <td>${product.slBan}</td>
                            <td>${product.dvt}</td>
                            <td>${formatCurrency(product.donGia)}</td>
                            <td>${formatCurrency(product.thanhTien)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
                }

                // Hiển thị ngày in
                const today = new Date();
                document.getElementById('print-day').textContent = today.getDate();
                document.getElementById('print-month').textContent = today.getMonth() + 1;
                document.getElementById('print-year').textContent = today.getFullYear();

                // Tự động in nếu có tham số ?print=true
                if (getUrlParameter('print') === 'true') {
                    window.print();
                }
                
            } catch (error) {
                console.error('Error processing invoice data:', error);
                alert('Có lỗi khi tải hóa đơn. Vui lòng kiểm tra lại dữ liệu.');
            }
        }

        // Chạy khi trang tải xong
        document.addEventListener('DOMContentLoaded', displayData);
    </script>
</body>
</html>
